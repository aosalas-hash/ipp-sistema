<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IPP ‚Äî Coordinador CE</title>
  <link rel="stylesheet" href="ipp-styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="app" id="app" style="display:none">

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="brand">
      <div class="brand-mark">I</div>
      <span class="brand-name">IPP</span>
      <span class="brand-role">CE</span>
    </div>
    <div class="topbar-right">
      <span class="user-info" id="user-email"></span>
      <button class="btn btn-secondary btn-sm" onclick="logout()">Salir</button>
    </div>
  </header>

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="nav-section">
      <div class="nav-label">Mis grupos</div>
      <a class="nav-item active" onclick="showView('mis-grupos')" href="#">
        <span class="nav-icon">üë•</span> Grupos asignados
      </a>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="main">

    <!-- ‚ïê‚ïê‚ïê VISTA: MIS GRUPOS ‚ïê‚ïê‚ïê -->
    <div id="view-mis-grupos" class="view fade-in">
      <div class="page-header">
        <div class="page-title">Mis grupos</div>
        <div class="page-sub">Grupos asignados para evaluaci√≥n en campo</div>
      </div>
      <div id="grupos-list">
        <div style="text-align:center;padding:40px;color:var(--muted);font-family:'DM Mono',monospace">
          Cargando grupos‚Ä¶
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê VISTA: EVALUACI√ìN DE INTEGRANTE ‚ïê‚ïê‚ïê -->
    <div id="view-integrante" class="view fade-in" style="display:none">
      <div class="page-header flex-between">
        <div>
          <button class="btn btn-secondary btn-sm" onclick="volverAGrupo()" style="margin-bottom:12px">
            ‚Üê Volver al grupo
          </button>
          <div class="page-title" id="int-nombre">Evaluaci√≥n individual</div>
          <div class="page-sub" id="int-sub"></div>
        </div>
        <div id="int-score-mini"></div>
      </div>

      <!-- Alto riesgo alert -->
      <div id="alto-riesgo-alert" class="alert alert-danger" style="display:none">
        <span class="alert-icon">üö®</span>
        <div>
          <strong>ALTO RIESGO detectado.</strong> Debes revisar cada punto antes de continuar.
          La decisi√≥n final requiere motivo obligatorio.
        </div>
      </div>

      <!-- Checklist conversacional -->
      <div class="card" id="checklist-card">
        <div class="card-title">üó£Ô∏è Checklist conversacional</div>
        <div id="checklist-items"></div>
      </div>

      <!-- Decisi√≥n -->
      <div class="card" style="margin-top:20px" id="decision-card">
        <div class="card-title">üìã Decisi√≥n CE</div>

        <div class="form-grid" style="margin-bottom:20px">
          <div class="field">
            <label>¬øDesignar como l√≠der del grupo?</label>
            <select id="ce-lider">
              <option value="false">No</option>
              <option value="true">S√≠</option>
            </select>
          </div>
          <div class="field">
            <label>Decisi√≥n</label>
            <select id="ce-decision" onchange="toggleMotivoRechazo()">
              <option value="">Selecciona‚Ä¶</option>
              <option value="aprobado">Aprobar integrante</option>
              <option value="rechazado">Rechazar integrante</option>
            </select>
          </div>
          <div class="field full" id="motivo-rechazo-field" style="display:none">
            <label id="motivo-label">Motivo de rechazo <span id="motivo-req"></span></label>
            <textarea id="ce-motivo" rows="3" placeholder="Describe el motivo‚Ä¶"></textarea>
          </div>
        </div>

        <button class="btn btn-primary" id="btn-guardar-decision" onclick="guardarDecisionCE()"
          disabled style="width:100%">
          Guardar decisi√≥n
        </button>
      </div>

      <!-- Encuesta piloto (mostrar despu√©s de aprobar) -->
      <div class="card" style="margin-top:20px;display:none" id="encuesta-card">
        <div class="card-title">üìä Encuesta piloto</div>
        <p style="font-size:13px;color:var(--muted);margin-bottom:20px">
          Completa las dos escalas de evaluaci√≥n grupal
        </p>
        <div id="encuesta-content"></div>
        <button class="btn btn-primary" style="margin-top:20px;width:100%" onclick="guardarEncuesta()">
          Guardar encuesta
        </button>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê VISTA: EVALUACI√ìN GRUPAL ‚ïê‚ïê‚ïê -->
    <div id="view-grupal" class="view fade-in" style="display:none">
      <div class="page-header flex-between">
        <div>
          <button class="btn btn-secondary btn-sm" onclick="volverAGrupoDesdeGrupal()" style="margin-bottom:12px">
            ‚Üê Volver
          </button>
          <div class="page-title" id="grupal-titulo">Calificaci√≥n grupal</div>
          <div class="page-sub">Evaluaci√≥n matem√°tica del grupo ‚Äî Instrumento grupal IPP</div>
        </div>
      </div>

      <div class="card" style="margin-bottom:20px" id="grupal-integrantes-card">
        <div class="card-title">üìä Scores individuales del grupo</div>
        <div id="grupal-tabla"></div>
      </div>

      <div class="card" style="margin-bottom:20px" id="grupal-score-card">
        <div class="card-title">üßÆ Score grupal calculado</div>
        <div id="grupal-resultado"></div>
      </div>

      <div class="card">
        <div class="card-title">üìã Decisi√≥n grupal CE</div>
        <div class="form-grid">
          <div class="field">
            <label>Decisi√≥n del grupo</label>
            <select id="dec-grupal" onchange="toggleMotivoGrupal()">
              <option value="">Selecciona‚Ä¶</option>
              <option value="aprobado">Aprobar grupo</option>
              <option value="rechazado">Rechazar grupo</option>
            </select>
          </div>
          <div class="field full" id="motivo-grupal-field" style="display:none">
            <label id="motivo-grupal-label">Motivo de rechazo</label>
            <textarea id="motivo-grupal" rows="3" placeholder="Describe el motivo‚Ä¶"></textarea>
          </div>
        </div>
        <button class="btn btn-primary" style="margin-top:16px;width:100%"
          id="btn-guardar-grupal" onclick="guardarDecisionGrupal()" disabled>
          Guardar decisi√≥n grupal
        </button>
      </div>
    </div>

  </main>
</div>

<script src="ipp-core.js"></script>
<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUser = null;
let grupoActual = null;
let integranteActual = null;
let integrantesGrupo = [];
let checklistState = {};

// Checklist conversacional (preguntas)
const CHECKLIST = [
  {
    id: 'conoce_producto',
    q: '¬øLa prospecto sabe c√≥mo funciona el cr√©dito grupal?',
    hint: 'Verificar que comprende montos, plazos y responsabilidad solidaria',
    tipo: 'yesno'
  },
  {
    id: 'conoce_grupo',
    q: '¬øConoce a las dem√°s integrantes del grupo?',
    hint: 'Deben tener relaci√≥n previa de confianza',
    tipo: 'yesno'
  },
  {
    id: 'domicilio_verificado',
    q: '¬øSe verific√≥ f√≠sicamente el domicilio declarado?',
    hint: 'Comparar con INE y observaci√≥n en campo',
    tipo: 'yesno'
  },
  {
    id: 'negocio_verificado',
    q: '¬øSe verific√≥ que el negocio existe y opera?',
    hint: 'Observaci√≥n directa del punto de venta',
    tipo: 'yesno'
  },
  {
    id: 'capacidad_pago',
    q: '¬øEl flujo neto declarado parece consistente con lo observado?',
    hint: 'Comparar ingresos declarados vs. nivel de vida aparente',
    tipo: 'yesno'
  },
  {
    id: 'sin_presiones',
    q: '¬øLa prospecto toma la decisi√≥n libremente, sin presiones externas?',
    hint: 'Detectar se√±ales de coacci√≥n o influencia de terceros',
    tipo: 'yesno'
  },
  {
    id: 'disponibilidad_pago',
    q: '¬øCuenta con disponibilidad de efectivo el d√≠a de pago acordado?',
    hint: 'Confirmar que el d√≠a de pago grupal no genera conflicto',
    tipo: 'yesno'
  },
  {
    id: 'observaciones',
    q: 'Observaciones adicionales del asesor',
    hint: 'Cualquier detalle relevante observado en campo',
    tipo: 'text'
  }
];

// Encuesta piloto: 2 escalas
const ENCUESTA_ESCALAS = [
  {
    id: 'cohesion',
    titulo: 'Escala 1 ‚Äî Cohesi√≥n y confianza del grupo',
    items: [
      { id: 'c1', q: '¬øLas integrantes se conocen entre s√≠?' },
      { id: 'c2', q: '¬øExiste comunicaci√≥n activa entre ellas?' },
      { id: 'c3', q: '¬øHay disposici√≥n a apoyarse en caso de dificultad?' },
      { id: 'c4', q: '¬øExiste acuerdo sobre la l√≠der del grupo?' },
    ]
  },
  {
    id: 'viabilidad',
    titulo: 'Escala 2 ‚Äî Viabilidad operativa',
    items: [
      { id: 'v1', q: '¬øLos negocios de las integrantes son compatibles en horario de pago?' },
      { id: 'v2', q: '¬øEl grupo tiene un punto de reuni√≥n acordado?' },
      { id: 'v3', q: '¬øLas integrantes comprenden la responsabilidad solidaria?' },
      { id: 'v4', q: '¬øEl grupo est√° dispuesto a formalizar en los pr√≥ximos 7 d√≠as?' },
    ]
  }
];

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async () => {
  const auth = await requireAuth(['CE']);
  if (!auth) return;
  currentUser = auth.profile;
  document.getElementById('user-email').textContent = auth.session.user.email;
  document.getElementById('app').style.display = 'grid';
  cargarMisGrupos();
})();

function showView(v) {
  document.querySelectorAll('.view').forEach(el => el.style.display = 'none');
  const el = document.getElementById(`view-${v}`);
  if (el) { el.style.display = 'block'; }
}

// ‚îÄ‚îÄ‚îÄ Mis grupos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function cargarMisGrupos() {
  // CE solo ve grupos asignados a √©l
  const { data: asignaciones } = await sb.from('asignaciones_ce')
    .select(`grupo_id, direccion, grupos(id, nombre, estatus, num_integrantes)`)
    .eq('ce_id', currentUser.id);

  const container = document.getElementById('grupos-list');

  if (!asignaciones?.length) {
    container.innerHTML = `
      <div style="text-align:center;padding:60px;color:var(--muted)">
        <div style="font-size:40px;margin-bottom:16px">üì≠</div>
        <div style="font-family:'DM Mono',monospace;font-size:13px">Sin grupos asignados por el momento</div>
      </div>
    `;
    return;
  }

  container.innerHTML = asignaciones.map(a => {
    const g = a.grupos;
    const puedeEvaluar = ['por_visitar', 'asignado', 'en_visita'].includes(g.estatus);
    return `
      <div class="card" style="margin-bottom:16px">
        <div class="flex-between" style="margin-bottom:16px">
          <div>
            <div style="font-size:18px;font-weight:700">${g.nombre}</div>
            <div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--muted)">${a.direccion}</div>
          </div>
          <div>${estatusBadge(g.estatus)}</div>
        </div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:16px">
          ${g.num_integrantes || 0} integrantes
        </div>
        <div class="row">
          <button class="btn btn-primary" onclick="abrirGrupo('${g.id}')" ${!puedeEvaluar ? 'disabled' : ''}>
            ${puedeEvaluar ? '‚ñ∂ Evaluar grupo' : '‚úì Evaluaci√≥n completada'}
          </button>
        </div>
      </div>
    `;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ Abrir grupo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function abrirGrupo(grupoId) {
  const { data: grupo } = await sb.from('grupos').select('*').eq('id', grupoId).single();
  const { data: integrantes } = await sb.from('integrantes')
    .select(`id, es_lider, evaluacion_ce, decision_ce, motivo_rechazo,
             prospectos(id, nombre_completo, score_ipp, grado_ipp, grado_postburo, ingresos_semanales, gastos_semanales, capacidad_pago)`)
    .eq('grupo_id', grupoId);

  grupoActual = grupo;
  integrantesGrupo = integrantes || [];

  // Actualizar estatus a en_visita si a√∫n es por_visitar
  if (grupo.estatus === 'por_visitar' || grupo.estatus === 'asignado') {
    await sb.from('grupos').update({ estatus: 'en_visita' }).eq('id', grupoId);
    grupoActual.estatus = 'en_visita';
  }

  renderGrupoCard();
}

function renderGrupoCard() {
  const todosCE = integrantesGrupo.every(i => i.decision_ce);
  const container = document.getElementById('grupos-list');

  container.innerHTML = `
    <div class="page-header flex-between">
      <div>
        <div class="page-title">${grupoActual.nombre}</div>
        <div class="page-sub">Evaluaci√≥n individual de integrantes</div>
      </div>
      <button class="btn btn-secondary btn-sm" onclick="cargarMisGrupos()">‚Üê Mis grupos</button>
    </div>

    <div class="card">
      <div class="card-title">Integrantes del grupo</div>
      ${integrantesGrupo.map(i => {
        const p = i.prospectos;
        const evaluado = !!i.decision_ce;
        const aprobado = i.decision_ce === 'aprobado';
        return `
          <div class="checklist-item">
            <div class="check-circle ${evaluado ? 'done' : ''}"
              onclick="${evaluado ? '' : `evalIntegrante('${i.id}')`}"
              title="${evaluado ? 'Evaluado' : 'Click para evaluar'}">
              ${evaluado ? '‚úì' : ''}
            </div>
            <div class="checklist-content">
              <div class="checklist-q">${p.nombre_completo} ${i.es_lider ? '‚≠ê' : ''}</div>
              <div class="checklist-hint">
                Score: ${p.score_ipp} ¬∑ ${badgeGrado(p.grado_ipp)}
                ${p.grado_postburo ? `‚Üí Post-bur√≥: ${badgeGrado(p.grado_postburo)}` : ''}
              </div>
              ${evaluado ? `
                <div style="margin-top:6px">
                  ${aprobado
                    ? '<span style="color:var(--success);font-size:12px;font-weight:600">‚úì APROBADA</span>'
                    : `<span style="color:var(--danger);font-size:12px;font-weight:600">‚úó RECHAZADA</span>`
                  }
                  ${i.motivo_rechazo ? `<div style="font-size:11px;color:var(--muted);margin-top:4px">${i.motivo_rechazo}</div>` : ''}
                </div>
              ` : `<button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="evalIntegrante('${i.id}')">Evaluar</button>`}
            </div>
          </div>
        `;
      }).join('')}
    </div>

    ${todosCE ? `
      <div style="margin-top:16px">
        <button class="btn btn-primary" style="width:100%" onclick="irCalificacionGrupal()">
          ‚Üí Calificaci√≥n grupal
        </button>
      </div>
    ` : `
      <div class="alert alert-info" style="margin-top:16px">
        <span class="alert-icon">‚ÑπÔ∏è</span>
        Eval√∫a a todas las integrantes para habilitar la calificaci√≥n grupal
      </div>
    `}
  `;
}

// ‚îÄ‚îÄ‚îÄ Evaluar integrante ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function evalIntegrante(integranteId) {
  const integrante = integrantesGrupo.find(i => i.id === integranteId);
  if (!integrante) return;
  integranteActual = integrante;
  const p = integrante.prospectos;

  document.getElementById('int-nombre').textContent = p.nombre_completo;
  document.getElementById('int-sub').textContent =
    `Score: ${p.score_ipp} ¬∑ Grado ${p.grado_ipp} ¬∑ Ingresos: $${(p.ingresos_semanales||0).toLocaleString()}/sem`;

  document.getElementById('int-score-mini').innerHTML = `
    <div style="text-align:center">
      <div style="font-size:40px;font-weight:800;font-family:'DM Mono',monospace">${p.score_ipp}</div>
      ${badgeGrado(p.grado_ipp)}
    </div>
  `;

  // Alert de alto riesgo
  const esAltoRiesgo = p.grado_ipp === 'C' || p.grado_postburo === 'C';
  document.getElementById('alto-riesgo-alert').style.display = esAltoRiesgo ? 'flex' : 'none';

  // Reset checklist
  checklistState = {};
  renderChecklist();

  // Reset decisi√≥n
  document.getElementById('ce-decision').value = '';
  document.getElementById('ce-lider').value = 'false';
  document.getElementById('motivo-rechazo-field').style.display = 'none';
  document.getElementById('btn-guardar-decision').disabled = true;
  document.getElementById('encuesta-card').style.display = 'none';

  showView('integrante');
}

function renderChecklist() {
  const container = document.getElementById('checklist-items');
  container.innerHTML = CHECKLIST.map(item => {
    const val = checklistState[item.id];
    if (item.tipo === 'text') {
      return `
        <div class="checklist-item">
          <div class="check-circle ${val ? 'done' : ''}" onclick="">üìù</div>
          <div class="checklist-content">
            <div class="checklist-q">${item.q}</div>
            <div class="checklist-answer">
              <textarea class="field" style="width:100%;background:var(--bg);border:1px solid var(--border);
                border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;
                padding:10px;outline:none;resize:vertical;min-height:60px"
                placeholder="Observaciones‚Ä¶"
                onchange="checklistState['${item.id}']=this.value;verificarChecklist()"
              >${val||''}</textarea>
            </div>
          </div>
        </div>
      `;
    }
    return `
      <div class="checklist-item">
        <div class="check-circle ${val==='si' ? 'done' : ''}"
          style="${val==='no' ? 'border-color:var(--danger)' : ''}">
          ${val === 'si' ? '‚úì' : val === 'no' ? '‚úó' : ''}
        </div>
        <div class="checklist-content">
          <div class="checklist-q">${item.q}</div>
          <div class="checklist-hint">${item.hint}</div>
          <div class="checklist-answer row" style="margin-top:10px;gap:10px">
            <button class="btn btn-sm ${val==='si' ? 'btn-primary' : 'btn-secondary'}"
              onclick="checklistState['${item.id}']='si';renderChecklist();verificarChecklist()">
              ‚úì S√≠
            </button>
            <button class="btn btn-sm ${val==='no' ? 'btn-danger' : 'btn-secondary'}"
              onclick="checklistState['${item.id}']='no';renderChecklist();verificarChecklist()">
              ‚úó No
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function verificarChecklist() {
  const respondidas = CHECKLIST.filter(i => i.tipo === 'yesno').every(i => checklistState[i.id]);
  document.getElementById('btn-guardar-decision').disabled = !respondidas ||
    !document.getElementById('ce-decision').value;
}

function toggleMotivoRechazo() {
  const decision = document.getElementById('ce-decision').value;
  const field = document.getElementById('motivo-rechazo-field');
  const p = integranteActual?.prospectos;
  const esAltoRiesgo = p?.grado_ipp === 'C' || p?.grado_postburo === 'C';

  if (decision === 'rechazado') {
    field.style.display = 'block';
    const req = esAltoRiesgo || p?.score_ipp >= 65 ? '(obligatorio)' : '(opcional)';
    document.getElementById('motivo-req').textContent = req;
    document.getElementById('motivo-req').style.color = esAltoRiesgo ? 'var(--danger)' : 'var(--muted)';
  } else {
    field.style.display = 'none';
  }
  verificarChecklist();
}

async function guardarDecisionCE() {
  const decision = document.getElementById('ce-decision').value;
  const esLider = document.getElementById('ce-lider').value === 'true';
  const motivo = document.getElementById('ce-motivo').value.trim();
  const p = integranteActual.prospectos;

  // Validar motivo obligatorio
  const scoreAlto = p.score_ipp >= 65;
  if (decision === 'rechazado' && scoreAlto && !motivo) {
    toast('El motivo de rechazo es obligatorio para este perfil (score ‚â• 65)', 'error');
    return;
  }

  const evaluacion = {
    respuestas: checklistState,
    timestamp: new Date().toISOString()
  };

  const { error } = await sb.from('integrantes').update({
    decision_ce: decision,
    es_lider: esLider,
    motivo_rechazo: motivo || null,
    evaluacion_ce: JSON.stringify(evaluacion),
    evaluado_por: currentUser.id,
    evaluado_at: new Date().toISOString()
  }).eq('id', integranteActual.id);

  if (error) { toast('Error guardando: ' + error.message, 'error'); return; }

  // Actualizar estatus del prospecto
  await sb.from('prospectos').update({
    estatus: decision === 'aprobado' ? 'aprobado_ce' : 'rechazado_ce'
  }).eq('id', p.id);

  // Actualizar estado local
  const idx = integrantesGrupo.findIndex(i => i.id === integranteActual.id);
  if (idx >= 0) {
    integrantesGrupo[idx].decision_ce = decision;
    integrantesGrupo[idx].es_lider = esLider;
    integrantesGrupo[idx].motivo_rechazo = motivo || null;
  }

  toast(`Integrante ${decision === 'aprobado' ? 'aprobada ‚úì' : 'rechazada ‚úó'}`);

  // Mostrar encuesta si se aprob√≥
  if (decision === 'aprobado') {
    renderEncuesta();
    document.getElementById('encuesta-card').style.display = 'block';
  } else {
    volverAGrupo();
  }
}

// ‚îÄ‚îÄ‚îÄ Encuesta piloto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEncuesta() {
  document.getElementById('encuesta-content').innerHTML = ENCUESTA_ESCALAS.map(escala => `
    <div style="margin-bottom:24px">
      <div style="font-size:13px;font-weight:700;margin-bottom:14px;color:var(--muted2)">${escala.titulo}</div>
      ${escala.items.map(item => `
        <div style="display:flex;align-items:center;justify-content:space-between;
          padding:12px 0;border-bottom:1px solid var(--border)">
          <div style="font-size:13px;flex:1;padding-right:16px">${item.q}</div>
          <div style="display:flex;gap:8px;flex-shrink:0">
            ${[1,2,3,4,5].map(n => `
              <label style="cursor:pointer">
                <input type="radio" name="enc-${item.id}" value="${n}" style="display:none" />
                <div class="likert-btn" data-id="${item.id}" data-val="${n}"
                  style="width:36px;height:36px;border-radius:8px;border:1px solid var(--border);
                    display:flex;align-items:center;justify-content:center;font-size:12px;
                    font-family:'DM Mono',monospace;cursor:pointer;transition:all 0.15s"
                  onclick="selectLikert('${item.id}',${n})">
                  ${n}
                </div>
              </label>
            `).join('')}
          </div>
        </div>
      `).join('')}
    </div>
  `).join('');
}

const likertState = {};
function selectLikert(id, val) {
  likertState[id] = val;
  document.querySelectorAll(`[data-id="${id}"]`).forEach(el => {
    const isSelected = parseInt(el.dataset.val) === val;
    el.style.background = isSelected ? 'rgba(232,255,71,0.15)' : 'transparent';
    el.style.borderColor = isSelected ? 'var(--accent)' : 'var(--border)';
    el.style.color = isSelected ? 'var(--accent)' : 'var(--text)';
  });
}

async function guardarEncuesta() {
  const allItems = ENCUESTA_ESCALAS.flatMap(e => e.items.map(i => i.id));
  const sinResponder = allItems.filter(id => !likertState[id]);
  if (sinResponder.length) {
    toast(`Responde todas las preguntas (${sinResponder.length} pendientes)`, 'warn');
    return;
  }

  const scoreEscala1 = ENCUESTA_ESCALAS[0].items.reduce((sum, i) => sum + (likertState[i.id]||0), 0);
  const scoreEscala2 = ENCUESTA_ESCALAS[1].items.reduce((sum, i) => sum + (likertState[i.id]||0), 0);

  const { error } = await sb.from('encuestas_piloto').insert({
    integrante_id: integranteActual.id,
    grupo_id: grupoActual.id,
    respuestas: JSON.stringify(likertState),
    score_escala1: scoreEscala1,
    score_escala2: scoreEscala2,
    score_total: scoreEscala1 + scoreEscala2,
    aplicada_por: currentUser.id
  });

  if (error) { toast('Error guardando encuesta: ' + error.message, 'error'); return; }
  toast('Encuesta guardada ‚úì');
  volverAGrupo();
}

// ‚îÄ‚îÄ‚îÄ Calificaci√≥n grupal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function irCalificacionGrupal() {
  showView('grupal');
  document.getElementById('grupal-titulo').textContent = `Calificaci√≥n grupal ‚Äî ${grupoActual.nombre}`;

  const aprobados = integrantesGrupo.filter(i => i.decision_ce === 'aprobado');
  const rechazados = integrantesGrupo.filter(i => i.decision_ce !== 'aprobado');
  const scores = aprobados.map(i => i.prospectos.score_ipp || 0);

  // L√≥gica matem√°tica grupal:
  // Score grupal = promedio ponderado de scores individuales aprobados
  // Penalizaci√≥n si hay integrantes rechazados
  const scorePromedio = scores.length ? Math.round(scores.reduce((a,b) => a+b, 0) / scores.length) : 0;
  const penalizacion = rechazados.length * 5; // -5 pts por cada rechazado
  const scoreGrupal = Math.max(0, scorePromedio - penalizacion);

  let gradoGrupal;
  if (scoreGrupal >= 80) gradoGrupal = 'A';
  else if (scoreGrupal >= 65) gradoGrupal = 'B';
  else if (scoreGrupal >= 50) gradoGrupal = 'C';
  else gradoGrupal = 'D';

  // Si alg√∫n integrante es D individual ‚Üí grupo no puede ser A
  const tieneD = aprobados.some(i => i.prospectos.grado_postburo === 'D' || i.prospectos.grado_ipp === 'D');
  if (tieneD && gradoGrupal === 'A') gradoGrupal = 'B';

  document.getElementById('grupal-tabla').innerHTML = `
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Integrante</th>
            <th>Score IPP</th>
            <th>Grado individual</th>
            <th>Decisi√≥n CE</th>
          </tr>
        </thead>
        <tbody>
          ${integrantesGrupo.map(i => {
            const p = i.prospectos;
            return `
              <tr>
                <td>${p.nombre_completo} ${i.es_lider ? '‚≠ê' : ''}</td>
                <td><strong style="font-family:'DM Mono',monospace">${p.score_ipp}</strong></td>
                <td>${badgeGrado(p.grado_ipp)}</td>
                <td>${i.decision_ce === 'aprobado'
                  ? '<span style="color:var(--success);font-weight:600">‚úì Aprobada</span>'
                  : '<span style="color:var(--danger);font-weight:600">‚úó Rechazada</span>'
                }</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;

  const colorGrupal = { A: '#2ed573', B: '#7c6af7', C: '#ffa502', D: '#ff4757' }[gradoGrupal];
  document.getElementById('grupal-resultado').innerHTML = `
    <div style="display:flex;align-items:center;gap:32px">
      <div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px">SCORE PROMEDIO INDIVIDUAL</div>
        <div style="font-size:28px;font-weight:800;font-family:'DM Mono',monospace">${scorePromedio}</div>
      </div>
      ${penalizacion > 0 ? `
        <div>
          <div style="font-size:11px;color:var(--danger);margin-bottom:6px">PENALIZACI√ìN</div>
          <div style="font-size:28px;font-weight:800;font-family:'DM Mono',monospace;color:var(--danger)">-${penalizacion}</div>
          <div style="font-size:11px;color:var(--muted)">${rechazados.length} integrante(s) rechazada(s)</div>
        </div>
      ` : ''}
      <div style="margin-left:auto;text-align:right">
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px">SCORE GRUPAL FINAL</div>
        <div style="font-size:48px;font-weight:800;font-family:'DM Mono',monospace;color:${colorGrupal}">${scoreGrupal}</div>
        ${badgeGrado(gradoGrupal)}
      </div>
    </div>
    <div style="margin-top:16px">
      <div class="score-bar"><div class="score-bar-fill" style="width:${scoreGrupal}%;background:${colorGrupal}"></div></div>
    </div>
    ${gradoGrupal === 'D' ? `
      <div class="alert alert-danger" style="margin-top:16px">
        <span class="alert-icon">üö®</span>
        Score grupal insuficiente. Se requiere motivo obligatorio para rechazar.
      </div>
    ` : ''}
  `;

  // Almacenar para guardado
  window._scoreGrupal = scoreGrupal;
  window._gradoGrupal = gradoGrupal;

  // Habilitar bot√≥n guardar al seleccionar decisi√≥n
  document.getElementById('dec-grupal').onchange = () => {
    toggleMotivoGrupal();
    document.getElementById('btn-guardar-grupal').disabled = false;
  };
}

function toggleMotivoGrupal() {
  const dec = document.getElementById('dec-grupal').value;
  const esAltoScore = (window._scoreGrupal || 0) >= 65;
  const field = document.getElementById('motivo-grupal-field');

  if (dec === 'rechazado') {
    field.style.display = 'block';
    document.getElementById('motivo-grupal-label').innerHTML =
      `Motivo de rechazo ${esAltoScore ? '<span style="color:var(--danger)">(obligatorio ‚Äî score alto)</span>' : '(opcional)'}`;
  } else {
    field.style.display = 'none';
  }
}

async function guardarDecisionGrupal() {
  const decision = document.getElementById('dec-grupal').value;
  const motivo = document.getElementById('motivo-grupal').value.trim();
  const esAltoScore = (window._scoreGrupal || 0) >= 65;

  if (decision === 'rechazado' && esAltoScore && !motivo) {
    toast('Motivo obligatorio cuando el score grupal es ‚â• 65', 'error');
    return;
  }

  const { error } = await sb.from('grupos').update({
    score_grupal: window._scoreGrupal,
    grado_grupal: window._gradoGrupal,
    decision_ce: decision,
    motivo_rechazo_ce: motivo || null,
    estatus: decision === 'aprobado' ? 'aprobado_ce' : 'rechazado_ce'
  }).eq('id', grupoActual.id);

  if (error) { toast('Error: ' + error.message, 'error'); return; }
  toast(`Grupo ${decision === 'aprobado' ? 'APROBADO ‚úì' : 'RECHAZADO ‚úó'}`);
  cargarMisGrupos();
  showView('mis-grupos');
}

function volverAGrupo() {
  showView('mis-grupos');
  renderGrupoCard();
}

function volverAGrupoDesdeGrupal() {
  showView('mis-grupos');
  renderGrupoCard();
}
</script>
</body>
</html>
